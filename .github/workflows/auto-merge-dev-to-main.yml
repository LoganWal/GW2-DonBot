name: Auto merge dev to main

on:
  schedule:
    - cron: '0 10 * * 1' # Every Monday at 10:00 UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if dev is ahead of main
        id: check
        run: |
          git fetch origin
          BEHIND=$(git rev-list origin/main..origin/dev --count)
          echo "commits_ahead=$BEHIND" >> $GITHUB_OUTPUT

      - name: Create PR if one doesn't exist
        if: steps.check.outputs.commits_ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number')
          if [ -z "$PR_EXISTS" ]; then
            gh pr create \
              --base main \
              --head dev \
              --title "chore: weekly merge dev into main" \
              --body "Automated weekly merge of \`dev\` into \`main\`."
          else
            echo "PR #$PR_EXISTS already exists, skipping creation."
          fi
